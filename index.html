<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Godplace Panel</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        /* Custom styles */
        .auth-container {
            max-width: 450px;
            margin: 50px auto;
            padding: 40px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .auth-tabs {
            display: flex;
            margin-bottom: 24px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .auth-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
        }
        
        .auth-tab.active {
            color: #d4af37;
            border-bottom-color: #d4af37;
            font-weight: 500;
        }
        
        .hidden {
            display: none !important;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            border: none;
            gap: 8px;
        }
        
        .btn-primary {
            background: #d4af37;
            color: white;
            border: 1px solid #d4af37;
        }
        
        .btn-primary:hover {
            background: #b8941f;
        }
        
        .btn-outline {
            background: transparent;
            color: #d4af37;
            border: 1px solid #d4af37;
        }
        
        .btn-outline:hover {
            background: #d4af37;
            color: white;
        }
        
        .btn-outline.active {
            background: #d4af37;
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-danger {
            background: #dc2626;
            color: white;
            border: 1px solid #dc2626;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-success {
            background: #10b981;
            color: white;
            border: 1px solid #10b981;
        }
        
        .btn-success:hover {
            background: #059669;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.875rem;
            transition: all 0.2s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 0 2px rgba(212, 175, 55, 0.2);
        }
        
        .alert {
            padding: 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            margin-top: 16px;
        }
        
        .alert-error {
            background: #fef2f2;
            border: 1px solid #fecaca;
            color: #dc2626;
        }
        
        .alert-success {
            background: #f0fdf4;
            border: 1px solid #bbf7d0;
            color: #166534;
        }
        
        .card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 24px;
        }
        
        .card-header {
            padding: 24px 24px 0 24px;
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #d4af37;
            margin-bottom: 8px;
        }
        
        .card-description {
            color: #6b7280;
            font-size: 0.875rem;
        }
        
        .card-content {
            padding: 24px;
        }
        
        .badge {
            padding: 4px 12px;
            border-radius: 16px;
            font-size: 0.75rem;
            font-weight: 500;
            margin: 2px;
        }
        
        .badge-active {
            background: #d4af37;
            color: white;
        }
        
        .badge-inactive {
            background: #f3f4f6;
            color: #6b7280;
        }
        
        .badge-admin {
            background: #d4af37;
            color: white;
        }
        
        .badge-modo {
            background: #10b981;
            color: white;
        }
        
        .user-info {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }
        
        .logs {
            background: #fffbea;
            border: 1px solid #d4af37;
            border-radius: 6px;
            padding: 16px;
            font-family: monospace;
            font-size: 0.875rem;
            color: #6b5e00;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(212, 175, 55, 0.1);
            border-radius: 4px;
            border-left: 3px solid #d4af37;
        }
        
        .user-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
        }
        
        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid #f3f4f6;
        }
        
        .user-item:last-child {
            border-bottom: none;
        }
        
        .user-item:hover {
            background: #f9fafb;
        }
        
        .grid {
            display: grid;
            gap: 16px;
        }
        
        .grid-cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .grid-cols-3 {
            grid-template-columns: repeat(3, 1fr);
        }
        
        .grid-cols-4 {
            grid-template-columns: repeat(4, 1fr);
        }
        
        .grid-cols-5 {
            grid-template-columns: repeat(5, 1fr);
        }
        
        @media (max-width: 768px) {
            .grid-cols-2, .grid-cols-3, .grid-cols-4, .grid-cols-5 {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .grid-cols-2, .grid-cols-3, .grid-cols-4, .grid-cols-5 {
                grid-template-columns: 1fr;
            }
        }
        
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #d4af37;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 8px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .channel-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            margin: 4px 0;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .channel-item:hover {
            background: #f9fafb;
            border-color: #d4af37;
        }

        .channel-item.selected {
            background: #d4af37;
            color: white;
            border-color: #d4af37;
        }

        .channel-type {
            margin-right: 8px;
            font-size: 1.2em;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Screen -->
    <div id="loadingScreen" class="min-h-screen flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">Chargement...</p>
        </div>
    </div>

    <!-- Auth Screen -->
    <div id="authScreen" class="auth-container hidden">
        <div class="text-center mb-8">
            <div class="text-4xl mb-4">üîê</div>
            <h1 class="text-2xl font-bold text-yellow-600 mb-2">Godplace Panel</h1>
            <p class="text-gray-600">Connexion ou inscription requise</p>
        </div>

        <!-- Auth Tabs -->
        <div class="auth-tabs">
            <div class="auth-tab active" data-tab="login">Connexion</div>
            <div class="auth-tab" data-tab="register">Inscription</div>
        </div>

        <!-- Login Form -->
        <form id="loginForm" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="loginEmail" class="form-input" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                <input type="password" id="loginPassword" class="form-input" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Pseudo Discord</label>
                <input type="text" id="loginDiscordPseudo" class="form-input" placeholder="VotrePseudo#1234" required>
            </div>
            <button type="submit" class="btn btn-primary w-full">
                üöÄ Se connecter
            </button>
        </form>

        <!-- Register Form -->
        <form id="registerForm" class="space-y-4 hidden">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                <input type="email" id="registerEmail" class="form-input" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Mot de passe</label>
                <input type="password" id="registerPassword" class="form-input" minlength="6" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Confirmer le mot de passe</label>
                <input type="password" id="registerPasswordConfirm" class="form-input" minlength="6" required>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Pseudo Discord</label>
                <input type="text" id="registerDiscordPseudo" class="form-input" placeholder="VotrePseudo#1234" required>
                <p class="text-xs text-gray-500 mt-1">‚ö†Ô∏è Votre pseudo Discord doit √™tre autoris√© par un mod√©rateur</p>
            </div>
            <button type="submit" class="btn btn-primary w-full">
                üìù S'inscrire
            </button>
        </form>

        <div id="authError" class="alert alert-error hidden"></div>
        <div id="authSuccess" class="alert alert-success hidden"></div>
    </div>

    <!-- Main Panel -->
    <div id="mainPanel" class="max-w-6xl mx-auto p-6 space-y-8 hidden">
        <!-- User Info -->
        <div class="user-info">
            <div class="flex items-center space-x-4">
                <div class="text-2xl">üë§</div>
                <div>
                    <div class="font-medium" id="userEmail"></div>
                    <div class="text-sm text-gray-500" id="userDiscord"></div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <span id="adminBadge" class="badge badge-admin hidden">Admin</span>
                <span id="modoBadge" class="badge badge-modo hidden">Mod√©rateur</span>
                <button id="logoutBtn" class="btn btn-danger">
                    üö™ D√©connexion
                </button>
            </div>
        </div>

        <!-- Header -->
        <div class="text-center">
            <h1 class="text-4xl font-bold text-yellow-600 mb-2">Godplace Panel</h1>
            <p class="text-gray-600 mb-4">Panneau d'administration</p>
            <button id="testBtn" class="btn btn-success">
                üîß Tester la connexion
            </button>
        </div>

        <!-- Authorized Users Management -->
        <div id="authorizedUsersSection" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">üë• Gestion des utilisateurs autoris√©s</h2>
                <p class="card-description">G√©rer la liste des pseudos Discord autoris√©s</p>
            </div>
            <div class="card-content">
                <div class="flex space-x-2 mb-4">
                    <input type="text" id="newUserPseudo" class="form-input flex-1" placeholder="Pseudo Discord (ex: User#1234)">
                    <button id="addUserBtn" class="btn btn-success">
                        ‚ûï Ajouter
                    </button>
                </div>
                <div id="authorizedUsersList" class="user-list">
                    <div class="p-5 text-center text-gray-500">Chargement des utilisateurs autoris√©s...</div>
                </div>
            </div>
        </div>

        <!-- Logs Section -->
        <div id="logsSection" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">üìã Logs des actions</h2>
                <p class="card-description">Historique des actions effectu√©es</p>
            </div>
            <div class="card-content">
                <div id="logs" class="logs">Chargement des logs...</div>
            </div>
        </div>

        <!-- Back Button -->
        <button id="backBtn" class="btn btn-outline hidden">
            ‚Üê Retour
        </button>

        <!-- Main Category Selection -->
        <div id="mainView" class="card">
            <div class="card-header">
                <h2 class="card-title">1. Choisissez une cat√©gorie</h2>
                <p class="card-description">S√©lectionnez la cat√©gorie de contenu √† envoyer</p>
            </div>
            <div class="card-content">
                <select id="categorySelect" class="form-input">
                    <option value="">-- S√©lectionnez une cat√©gorie --</option>
                    <option value="Bandeaux">Bandeaux</option>
                    <option value="mondeEnDeclin">Le Monde en D√©clin</option>
                    <option value="gagneCoeurChrist">Gagne le c≈ìur du Christ</option>
                    <option value="loueAvecTonArt">Loue avec ton art</option>
                    <option value="chaineSacree">Cha√Æne sacr√©e</option>
                    <option value="savoirChretien">Savoir chr√©tien</option>
                    <option value="jePrefere">Je pr√©f√®re</option>
                    <option value="jeDebats">Je d√©bats</option>
                    <option value="composeTonChant">Compose ton chant</option>
                    <option value="priereEnChoeur">Pri√®re en ch≈ìur</option>
                    <option value="quiSuisJeBiblique">Qui suis-je biblique</option>
                    <option value="comprendreApocalypse">Comprendre l'apocalypse</option>
                    <option value="bibleIllustree">LA Bible illustr√©e</option>
                    <option value="cinemaChretien">Cin√©ma Chr√©tien</option>
                    <option value="jeux">Jeux</option>
                </select>
            </div>
        </div>

        <!-- Games Selection -->
        <div id="gamesView" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">Choisissez un jeu</h2>
                <p class="card-description">S√©lectionnez le type de jeu</p>
            </div>
            <div class="card-content">
                <div class="grid grid-cols-2 gap-4">
                    <button class="btn btn-outline h-20 text-lg" data-game="grilleDeLumiere">
                        Grille de lumi√®re
                    </button>
                    <button class="btn btn-outline h-20 text-lg" data-game="eclaireurs">
                        √âclaireurs
                    </button>
                </div>
            </div>
        </div>

        <!-- Week Selection -->
        <div id="weekView" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">2. Choisissez une option</h2>
                <p id="weekDescription" class="card-description">S√©lectionnez une option</p>
            </div>
            <div class="card-content">
                <div id="weekButtons" class="grid grid-cols-5 gap-2"></div>
            </div>
        </div>

        <!-- Image Preview -->
        <div id="previewView" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">üëÅÔ∏è 3. Aper√ßu</h2>
                <p class="card-description">Pr√©visualisation de l'image s√©lectionn√©e</p>
            </div>
            <div class="card-content">
                <div class="text-center">
                    <img id="previewImage" src="/placeholder.svg" alt="Aper√ßu de l'image s√©lectionn√©e" 
                         class="max-w-full h-auto border-2 border-yellow-600 rounded-lg shadow-lg mx-auto" 
                         style="max-height: 400px;">
                </div>
            </div>
        </div>

        <!-- Server Selection -->
        <div id="serverView" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">4. Choisissez un serveur Discord</h2>
                <p class="card-description">S√©lectionnez le serveur Discord cible</p>
            </div>
            <div class="card-content">
                <input type="text" id="serverIdInput" class="form-input mb-4" placeholder="ID du serveur Discord (ex: 1234567890123456789)">
                <button id="loadServerBtn" class="btn btn-primary w-full">
                    üîç Charger les salons du serveur
                </button>
                <div id="serverError" class="alert alert-error hidden"></div>
            </div>
        </div>

        <!-- Channel Selection -->
        <div id="channelView" class="card hidden">
            <div class="card-header">
                <h2 class="card-title">5. Choisissez un salon</h2>
                <p class="card-description">S√©lectionnez le salon o√π envoyer le contenu</p>
            </div>
            <div class="card-content space-y-4">
                <div id="channelsList" class="max-h-64 overflow-y-auto">
                    <!-- Les salons seront charg√©s ici -->
                </div>
                <button id="sendBtn" class="btn btn-primary w-full" disabled>
                    üì§ Envoyer au bot Discord
                </button>
                <div id="sendError" class="alert alert-error hidden"></div>
            </div>
        </div>

        <!-- Status Badges -->
        <div class="flex flex-wrap gap-2 justify-center">
            <span id="categoryBadge" class="badge badge-inactive">Cat√©gorie: Non s√©lectionn√©e</span>
            <span id="weekBadge" class="badge badge-inactive">Option: Non s√©lectionn√©e</span>
            <span id="serverBadge" class="badge badge-inactive">Serveur: Non s√©lectionn√©</span>
            <span id="channelBadge" class="badge badge-inactive">Salon: Non s√©lectionn√©</span>
        </div>
    </div>

    <script>
console.log('üöÄ D√©marrage de l\'application...');

// Configuration Firebase
const firebaseConfig = {
    apiKey: "AIzaSyDuY1T6HaxfDbEcZZYOrpDcD5LPNUTmeUc",
    authDomain: "godplace-dea67.firebaseapp.com",
    projectId: "godplace-dea67",
    storageBucket: "godplace-dea67.firebasestorage.app",
    messagingSenderId: "774010087004",
    appId: "1:774010087004:web:31346dfbc1b2adfed2e899",
    measurementId: "G-HNXY5FDSZK"
};

// Initialiser Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Configuration
const ADMIN_EMAILS = [
    "guylann.couvri@gmail.com",
    "cineustaci@gmail.com",
    "elyna933@gmail.com"
];

const MODO_EMAILS = [
    "modo1@example.com",
    "modo2@example.com"
];

// ‚ö†Ô∏è REMPLACEZ PAR VOTRE TOKEN DE BOT
const BOT_TOKEN = 'MTM2NTQyNjA0MzUzNTYyNjM2MQ.GVj5Zm.j-In9IJM9Z7Mvc5vUJ8yAu7OShPiDLwDY9ok5c';

// Variables globales
let currentUser = null;
let userDiscordPseudo = '';
let isAdmin = false;
let isModo = false;
let currentView = 'main';
let selectedCategory = '';
let selectedGame = '';
let selectedWeek = '';
let selectedChannel = '';
let selectedChannelName = '';
let selectedServerId = '';
let selectedServerName = '';
let selectedImage = '';
let isLoading = false;
let availableChannels = [];

// Donn√©es des cat√©gories COMPL√àTES
const categories = {
    mondeEnDeclin: {
        title: "Le Monde en D√©clin",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365725262414876693/FICHES_SPECIFIQUES_PETIT_FORMAT_-_4.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365725295369388042/FICHES_SPECIFIQUES_PETIT_FORMAT_-_5.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365725348314222754/FICHES_SPECIFIQUES_PETIT_FORMAT_-_6.png"
        }
    },
    gagneCoeurChrist: {
        title: "Gagne le c≈ìur du Christ",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365725653625864284/FICHES_SPECIFIQUES_PETIT_FORMAT_-_13.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365725697045434488/FICHES_SPECIFIQUES_PETIT_FORMAT_-_14.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365725725654782062/FICHES_SPECIFIQUES_PETIT_FORMAT_-_15.png"
        }
    },
    Bandeaux: {
        title: "Bandeaux",
        weeks: {
            "√† vos solutions": "https://media.discordapp.net/attachments/1365412596655853699/1365449720411062312/BANDEAUX_-_27.png",
            "Place au challenge": "https://media.discordapp.net/attachments/1365412596655853699/1365449778531537029/BANDEAUX_-_19.png",
            "Place √† la victoire": "https://media.discordapp.net/attachments/1365412596655853699/1365449855157407754/BANDEAUX_-_29.png",
            "Team oui ou team non": "https://media.discordapp.net/attachments/1365412596655853699/1365449952163266712/BANDEAUX_-_31.png",
            "Pr√©parez votre d√©fense": "https://media.discordapp.net/attachments/1365412596655853699/1365450022350749717/BANDEAUX_-_23.png",
            "face √† face": "https://media.discordapp.net/attachments/1365412596655853699/1365450102835249172/BANDEAUX_-_33.png",
            "√† vos votes": "https://media.discordapp.net/attachments/1365412596655853699/1365450176457609216/BANDEAUX_-_35.png",
            "Installez-vous": "https://media.discordapp.net/attachments/1365412596655853699/1365450239045144576/BANDEAUX_-_36.png",
            "on papote": "https://media.discordapp.net/attachments/1365412596655853699/1365450337854427267/BANDEAUX_-_37.png",
            "√† vos Bibles": "https://media.discordapp.net/attachments/1365412596655853699/1365450502476795945/BANDEAUX_-_39.png"
        }
    },
    loueAvecTonArt: {
        title: "Loue avec ton art",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365725770085040218/FICHES_SPECIFIQUES_PETIT_FORMAT_-_16.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365725825047068722/FICHES_SPECIFIQUES_PETIT_FORMAT_-_17.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365725866457567416/FICHES_SPECIFIQUES_PETIT_FORMAT_-_18.png"
        }
    },
    chaineSacree: {
        title: "Cha√Æne sacr√©e",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365725911411851344/FICHES_SPECIFIQUES_PETIT_FORMAT_-_19.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365725981528166450/FICHES_SPECIFIQUES_PETIT_FORMAT_-_20.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726016988465158/FICHES_SPECIFIQUES_PETIT_FORMAT_-_21.png"
        }
    },
    savoirChretien: {
        title: "Savoir chr√©tien",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726058002784767/FICHES_SPECIFIQUES_PETIT_FORMAT_-_22.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726094986149378/FICHES_SPECIFIQUES_PETIT_FORMAT_-_23.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726124882736641/FICHES_SPECIFIQUES_PETIT_FORMAT_-_24.png"
        }
    },
    jePrefere: {
        title: "Je pr√©f√®re",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726155632450067/FICHES_SPECIFIQUES_PETIT_FORMAT_-_25.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726183903265536/FICHES_SPECIFIQUES_PETIT_FORMAT_-_26.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726215589114901/FICHES_SPECIFIQUES_PETIT_FORMAT_-_27.png"
        }
    },
    jeDebats: {
        title: "Je d√©bats",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726250338652418/FICHES_SPECIFIQUES_PETIT_FORMAT_-_28.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726283172867072/FICHES_SPECIFIQUES_PETIT_FORMAT_-_29.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726313883936275/FICHES_SPECIFIQUES_PETIT_FORMAT_-_30.png"
        }
    },
    composeTonChant: {
        title: "Compose ton chant",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726345386018823/FICHES_SPECIFIQUES_PETIT_FORMAT_-_31.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726374519505411/FICHES_SPECIFIQUES_PETIT_FORMAT_-_32.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726412025523506/FICHES_SPECIFIQUES_PETIT_FORMAT_-_33.png"
        }
    },
    priereEnChoeur: {
        title: "Pri√®re en ch≈ìur",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726445561549856/FICHES_SPECIFIQUES_PETIT_FORMAT_-_34.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726477503522300/FICHES_SPECIFIQUES_PETIT_FORMAT_-_35.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726504952314986/FICHES_SPECIFIQUES_PETIT_FORMAT_-_36.png"
        }
    },
    quiSuisJeBiblique: {
        title: "Qui suis-je biblique",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726536286921778/FICHES_SPECIFIQUES_PETIT_FORMAT_-_37.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726566499025000/FICHES_SPECIFIQUES_PETIT_FORMAT_-_38.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726598318859014/FICHES_SPECIFIQUES_PETIT_FORMAT_-_39.png"
        }
    },
    comprendreApocalypse: {
        title: "Comprendre l'apocalypse",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726630002579476/FICHES_SPECIFIQUES_PETIT_FORMAT_-_40.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726663403672848/FICHES_SPECIFIQUES_PETIT_FORMAT_-_41.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726700276018184/FICHES_SPECIFIQUES_PETIT_FORMAT_-_42.png"
        }
    },
    bibleIllustree: {
        title: "LA Bible illustr√©e",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726733322940924/FICHES_SPECIFIQUES_PETIT_FORMAT_-_43.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726763165978650/FICHES_SPECIFIQUES_PETIT_FORMAT_-_44.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726794945651970/FICHES_SPECIFIQUES_PETIT_FORMAT_-_45.png"
        }
    },
    cinemaChretien: {
        title: "Cin√©ma Chr√©tien",
        weeks: {
            "Semaine 1": "https://media.discordapp.net/attachments/1365412596655853699/1365726824389902396/FICHES_SPECIFIQUES_PETIT_FORMAT_-_46.png",
            "Semaine 2": "https://media.discordapp.net/attachments/1365412596655853699/1365726860361834760/FICHES_SPECIFIQUES_PETIT_FORMAT_-_47.png",
            "Semaine 3": "https://media.discordapp.net/attachments/1365412596655853699/1365726891917857532/FICHES_SPECIFIQUES_PETIT_FORMAT_-_48.png"
        }
    }
};

const gameCategories = {
    grilleDeLumiere: {
        title: "Grille de lumi√®re",
        buttons: {
            "Grille de lumi√®re 1": "https://media.discordapp.net/attachments/1365412596655853699/1381746959072628826/PLATEAUX_CODES_SACRES_-_3.png",
            "Grille de lumi√®re 2": "https://media.discordapp.net/attachments/1365412596655853699/1381747211351883867/PLATEAUX_CODES_SACRES_-_6.png",
            "Grille de lumi√®re 3": "https://media.discordapp.net/attachments/1365412596655853699/1381747610108432527/PLATEAUX_CODES_SACRES.png",
            "Grille de lumi√®re 4": "https://media.discordapp.net/attachments/1365412596655853699/1381747659450355836/PLATEAUX_CODES_SACRES_-_12.png",
            "Grille de lumi√®re 5": "https://media.discordapp.net/attachments/1365412596655853699/1381747879051395174/PLATEAUX_CODES_SACRES.png",
            "Grille de lumi√®re 6": "https://media.discordapp.net/attachments/1365412596655853699/1381748077844627617/PLATEAUX_CODES_SACRES_-_18.png",
            "Grille de lumi√®re 7": "https://media.discordapp.net/attachments/1365412596655853699/1381748456841810021/PLATEAUX_CODES_SACRES.png",
            "Grille de lumi√®re 8": "https://media.discordapp.net/attachments/1365412596655853699/1381748553675964709/PLATEAUX_CODES_SACRES_-_24.png",
            "Grille de lumi√®re 9": "https://media.discordapp.net/attachments/1365412596655853699/1381748623842218034/PLATEAUX_CODES_SACRES_-_28.png",
            "Grille de lumi√®re 10": "https://media.discordapp.net/attachments/1365412596655853699/1381748876700291162/PLATEAUX_CODES_SACRES.png"
        }
    },
    eclaireurs: {
        title: "√âclaireurs",
        buttons: {
            "√âclaireurs 1": "https://media.discordapp.net/attachments/1365412596655853699/1381747093592342528/PLATEAUX_CODES_SACRES_-_4.png",
            "√âclaireurs 2": "https://media.discordapp.net/attachments/1365412596655853699/1381747251466211559/PLATEAUX_CODES_SACRES_-_7.png",
            "√âclaireurs 3": "https://media.discordapp.net/attachments/1365412596655853699/1381747367199510549/PLATEAUX_CODES_SACRES_-_10.png",
            "√âclaireurs 4": "https://media.discordapp.net/attachments/1365412596655853699/1381747699107234003/PLATEAUX_CODES_SACRES_-_13.png",
            "√âclaireurs 5": "https://media.discordapp.net/attachments/1365412596655853699/1381748030075568199/PLATEAUX_CODES_SACRES_-_16.png",
            "√âclaireurs 6": "https://media.discordapp.net/attachments/1365412596655853699/1381748122304249896/PLATEAUX_CODES_SACRES_-_19.png",
            "√âclaireurs 7": "https://media.discordapp.net/attachments/1365412596655853699/1381748505860767805/PLATEAUX_CODES_SACRES_-_22.png",
            "√âclaireurs 8": "https://media.discordapp.net/attachments/1365412596655853699/1381748588476104835/PLATEAUX_CODES_SACRES_-_25.png",
            "√âclaireurs 9": "https://media.discordapp.net/attachments/1365412596655853699/1381748653026312272/PLATEAUX_CODES_SACRES_-_27.png",
            "√âclaireurs 10": "https://media.discordapp.net/attachments/1365412596655853699/1381749325507465226/PLATEAUX_CODES_SACRES_-_31.png",
            "√âclaireurs 11": "https://media.discordapp.net/attachments/1365412596655853699/1381749407732469922/PLATEAUX_CODES_SACRES_-_36.png",
            "√âclaireurs 12": "https://media.discordapp.net/attachments/1365412596655853699/1381749515937120257/PLATEAUX_CODES_SACRES_-_40.png",
            "√âclaireurs 13": "https://media.discordapp.net/attachments/1365412596655853699/1381749593733071009/PLATEAUX_CODES_SACRES.png",
            "√âclaireurs 14": "https://media.discordapp.net/attachments/1365412596655853699/1381749662737891459/PLATEAUX_CODES_SACRES_-_45.png"
        }
    }
};

// √âl√©ments DOM
const elements = {
    loadingScreen: document.getElementById('loadingScreen'),
    authScreen: document.getElementById('authScreen'),
    mainPanel: document.getElementById('mainPanel'),
    loginForm: document.getElementById('loginForm'),
    registerForm: document.getElementById('registerForm'),
    authError: document.getElementById('authError'),
    authSuccess: document.getElementById('authSuccess'),
    userEmail: document.getElementById('userEmail'),
    userDiscord: document.getElementById('userDiscord'),
    adminBadge: document.getElementById('adminBadge'),
    modoBadge: document.getElementById('modoBadge'),
    logoutBtn: document.getElementById('logoutBtn'),
    logsSection: document.getElementById('logsSection'),
    authorizedUsersSection: document.getElementById('authorizedUsersSection'),
    authorizedUsersList: document.getElementById('authorizedUsersList'),
    newUserPseudo: document.getElementById('newUserPseudo'),
    addUserBtn: document.getElementById('addUserBtn'),
    mainView: document.getElementById('mainView'),
    gamesView: document.getElementById('gamesView'),
    weekView: document.getElementById('weekView'),
    previewView: document.getElementById('previewView'),
    serverView: document.getElementById('serverView'),
    serverIdInput: document.getElementById('serverIdInput'),
    loadServerBtn: document.getElementById('loadServerBtn'),
    serverError: document.getElementById('serverError'),
    channelView: document.getElementById('channelView'),
    channelsList: document.getElementById('channelsList'),
    backBtn: document.getElementById('backBtn'),
    categorySelect: document.getElementById('categorySelect'),
    weekButtons: document.getElementById('weekButtons'),
    weekDescription: document.getElementById('weekDescription'),
    previewImage: document.getElementById('previewImage'),
    sendBtn: document.getElementById('sendBtn'),
    sendError: document.getElementById('sendError'),
    testBtn: document.getElementById('testBtn'),
    logs: document.getElementById('logs'),
    categoryBadge: document.getElementById('categoryBadge'),
    weekBadge: document.getElementById('weekBadge'),
    serverBadge: document.getElementById('serverBadge'),
    channelBadge: document.getElementById('channelBadge')
};

// Fonctions utilitaires
function showElement(element) {
    if (element) {
        element.classList.remove('hidden');
    }
}

function hideElement(element) {
    if (element) {
        element.classList.add('hidden');
    }
}

function showError(message) {
    if (elements.authError) {
        elements.authError.textContent = message;
        showElement(elements.authError);
        hideElement(elements.authSuccess);
    }
}

function showSuccess(message) {
    if (elements.authSuccess) {
        elements.authSuccess.textContent = message;
        showElement(elements.authSuccess);
        hideElement(elements.authError);
    }
}

function clearMessages() {
    hideElement(elements.authError);
    hideElement(elements.authSuccess);
}

function showAuthScreen() {
    hideElement(elements.loadingScreen);
    showElement(elements.authScreen);
    hideElement(elements.mainPanel);
}

function showMainPanel() {
    hideElement(elements.loadingScreen);
    hideElement(elements.authScreen);
    showElement(elements.mainPanel);

    if (elements.userEmail && currentUser) {
        elements.userEmail.textContent = currentUser.email;
    }
    if (elements.userDiscord) {
        elements.userDiscord.textContent = `Discord: ${userDiscordPseudo}`;
    }

    if (isAdmin) {
        showElement(elements.adminBadge);
        hideElement(elements.modoBadge);
        showElement(elements.logsSection);
        showElement(elements.authorizedUsersSection);
        loadLogs();
        loadAuthorizedUsers();
    } else if (isModo) {
        hideElement(elements.adminBadge);
        showElement(elements.modoBadge);
        showElement(elements.logsSection);
        showElement(elements.authorizedUsersSection);
        loadLogs();
        loadAuthorizedUsers();
    } else {
        hideElement(elements.adminBadge);
        hideElement(elements.modoBadge);
        hideElement(elements.logsSection);
        hideElement(elements.authorizedUsersSection);
    }
}

function checkUserRole(email) {
    const isAdminUser = ADMIN_EMAILS.includes(email);
    const isModoUser = MODO_EMAILS.includes(email);
    return { isAdmin: isAdminUser, isModo: isModoUser };
}

// Fonctions de gestion du panel principal
function hideAllViews() {
    hideElement(elements.mainView);
    hideElement(elements.gamesView);
    hideElement(elements.weekView);
    hideElement(elements.previewView);
    hideElement(elements.serverView);
    hideElement(elements.channelView);
}

function showView(viewName) {
    hideAllViews();
    currentView = viewName;

    if (viewName === 'main') {
        showElement(elements.mainView);
        hideElement(elements.backBtn);
    } else if (viewName === 'games') {
        showElement(elements.gamesView);
        showElement(elements.backBtn);
    } else if (viewName === 'game-detail') {
        showElement(elements.weekView);
        showElement(elements.backBtn);
    }
}

function resetSelection() {
    selectedCategory = '';
    selectedGame = '';
    selectedWeek = '';
    selectedChannel = '';
    selectedChannelName = '';
    selectedServerId = '';
    selectedServerName = '';
    selectedImage = '';
    hideElement(elements.previewView);
    hideElement(elements.serverView);
    hideElement(elements.channelView);
    updateBadges();
    updateSendButton();
}

function updateBadges() {
    const categoryTitle = selectedCategory ? categories[selectedCategory]?.title : selectedGame ? gameCategories[selectedGame]?.title : 'Non s√©lectionn√©e';
    elements.categoryBadge.textContent = `Cat√©gorie: ${categoryTitle}`;
    elements.categoryBadge.className = `badge ${selectedCategory || selectedGame ? 'badge-active' : 'badge-inactive'}`;

    elements.weekBadge.textContent = `Option: ${selectedWeek || 'Non s√©lectionn√©e'}`;
    elements.weekBadge.className = `badge ${selectedWeek ? 'badge-active' : 'badge-inactive'}`;

    elements.serverBadge.textContent = `Serveur: ${selectedServerName || 'Non s√©lectionn√©'}`;
    elements.serverBadge.className = `badge ${selectedServerId ? 'badge-active' : 'badge-inactive'}`;

    elements.channelBadge.textContent = `Salon: ${selectedChannelName || 'Non s√©lectionn√©'}`;
    elements.channelBadge.className = `badge ${selectedChannel ? 'badge-active' : 'badge-inactive'}`;
}

function updateSendButton() {
    const canSend = selectedImage && selectedChannel && selectedServerId && !isLoading;
    elements.sendBtn.disabled = !canSend;
    elements.sendBtn.textContent = isLoading ? '‚è≥ Envoi en cours...' : 'üì§ Envoyer au bot Discord';
}

function showWeekButtons(categoryKey, isGame = false) {
    elements.weekButtons.innerHTML = '';
    const data = isGame ? gameCategories[categoryKey]?.buttons : categories[categoryKey]?.weeks;
    if (!data) return;

    const itemCount = Object.keys(data).length;
    let gridClass = 'grid-cols-3';
    if (itemCount >= 10) {
        gridClass = 'grid-cols-5';
    } else if (itemCount >= 6) {
        gridClass = 'grid-cols-4';
    } else if (itemCount >= 4) {
        gridClass = 'grid-cols-3';
    } else {
        gridClass = 'grid-cols-2';
    }

    elements.weekButtons.className = `grid ${gridClass} gap-2`;

    Object.keys(data).forEach(week => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-outline';
        btn.style.height = 'auto';
        btn.style.padding = '8px';
        btn.style.fontSize = '0.75rem';
        btn.textContent = week;
        btn.onclick = () => selectWeek(week, data[week]);
        if (!data[week]) {
            btn.disabled = true;
        }
        elements.weekButtons.appendChild(btn);
    });

    const title = isGame ? gameCategories[categoryKey]?.title : categories[categoryKey]?.title;
    elements.weekDescription.textContent = `S√©lectionnez une option pour ${title}`;
    showElement(elements.weekView);
}

function selectWeek(week, imageUrl) {
    selectedWeek = week;
    selectedImage = imageUrl;

    elements.weekButtons.querySelectorAll('button').forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent === week) {
            btn.classList.add('active');
        }
    });

    elements.previewImage.src = imageUrl;
    showElement(elements.previewView);
    showElement(elements.serverView);
    updateBadges();
    updateSendButton();
}

// Fonction pour charger les salons d'un serveur
async function loadServerChannels() {
    const serverId = elements.serverIdInput.value.trim();
    if (!serverId) {
        elements.serverError.textContent = 'Veuillez entrer un ID de serveur';
        showElement(elements.serverError);
        return;
    }

    elements.loadServerBtn.disabled = true;
    elements.loadServerBtn.innerHTML = 'üîÑ Chargement...';
    hideElement(elements.serverError);

    try {
        // R√©cup√©rer les informations du serveur
        const guildResponse = await fetch(`https://discord.com/api/v10/guilds/${serverId}`, {
            headers: {
                'Authorization': `Bot ${BOT_TOKEN}`,
            }
        });

        if (!guildResponse.ok) {
            if (guildResponse.status === 403) {
                throw new Error('Le bot n\'a pas acc√®s √† ce serveur');
            } else if (guildResponse.status === 404) {
                throw new Error('Serveur introuvable');
            } else {
                throw new Error(`Erreur ${guildResponse.status}: ${guildResponse.statusText}`);
            }
        }

        const guild = await guildResponse.json();
        selectedServerId = serverId;
        selectedServerName = guild.name;

        // R√©cup√©rer les salons du serveur
        const channelsResponse = await fetch(`https://discord.com/api/v10/guilds/${serverId}/channels`, {
            headers: {
                'Authorization': `Bot ${BOT_TOKEN}`,
            }
        });

        if (!channelsResponse.ok) {
            throw new Error(`Erreur lors de la r√©cup√©ration des salons: ${channelsResponse.status}`);
        }

        const channels = await channelsResponse.json();
        
        // Filtrer seulement les salons texte (type 0) et les fils de discussion (type 11)
        availableChannels = channels.filter(channel => 
            channel.type === 0 || channel.type === 5 || channel.type === 11
        ).sort((a, b) => a.name.localeCompare(b.name));

        displayChannels();
        showElement(elements.channelView);
        updateBadges();

    } catch (error) {
        console.error('Erreur chargement serveur:', error);
        elements.serverError.textContent = `‚ùå ${error.message}`;
        showElement(elements.serverError);
    } finally {
        elements.loadServerBtn.disabled = false;
        elements.loadServerBtn.innerHTML = 'üîç Charger les salons du serveur';
    }
}

function displayChannels() {
    elements.channelsList.innerHTML = '';

    if (availableChannels.length === 0) {
        elements.channelsList.innerHTML = '<div class="p-4 text-center text-gray-500">Aucun salon accessible trouv√©</div>';
        return;
    }

    availableChannels.forEach(channel => {
        const channelDiv = document.createElement('div');
        channelDiv.className = 'channel-item';
        channelDiv.onclick = () => selectChannel(channel.id, channel.name);

        const typeIcon = getChannelTypeIcon(channel.type);
        
        channelDiv.innerHTML = `
            <span class="channel-type">${typeIcon}</span>
            <span class="flex-1">${channel.name}</span>
        `;

        elements.channelsList.appendChild(channelDiv);
    });
}

function getChannelTypeIcon(type) {
    switch (type) {
        case 0: return '#'; // Salon texte
        case 5: return 'üì¢'; // Salon d'annonces
        case 11: return 'üßµ'; // Fil de discussion
        default: return '#';
    }
}

function selectChannel(channelId, channelName) {
    selectedChannel = channelId;
    selectedChannelName = channelName;

    // Mettre √† jour l'affichage
    elements.channelsList.querySelectorAll('.channel-item').forEach(item => {
        item.classList.remove('selected');
    });

    event.currentTarget.classList.add('selected');
    
    updateBadges();
    updateSendButton();
}

async function sendToDiscord() {
    if (!selectedImage || !selectedChannel || !selectedServerId) return;

    isLoading = true;
    updateSendButton();
    hideElement(elements.sendError);

    try {
        const response = await fetch(`https://discord.com/api/v10/channels/${selectedChannel}/messages`, {
            method: 'POST',
            headers: {
                'Authorization': `Bot ${BOT_TOKEN}`,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                content: `**${selectedCategory || selectedGame}** - ${selectedWeek}`,
                embeds: [{
                    title: `${selectedCategory || selectedGame} - ${selectedWeek}`,
                    image: {
                        url: selectedImage
                    },
                    color: 0xD4AF37,
                    footer: {
                        text: `Envoy√© par ${userDiscordPseudo} via Godplace Panel`,
                    },
                    timestamp: new Date().toISOString()
                }]
            })
        });

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`Erreur Discord API (${response.status}): ${errorData.message || 'Erreur inconnue'}`);
        }

        // Sauvegarder le log
        await saveLog(
            'Message envoy√©',
            `Serveur: ${selectedServerName} (${selectedServerId}) | Salon: ${selectedChannelName} | Cat√©gorie: ${selectedCategory || selectedGame} | Option: ${selectedWeek}`
        );

        alert(`‚úÖ Message envoy√© avec succ√®s dans "${selectedChannelName}" sur le serveur "${selectedServerName}" !`);

        if (isAdmin || isModo) {
            loadLogs();
        }
    } catch (error) {
        console.error('Erreur:', error);

        await saveLog(
            'Erreur envoi message',
            `Erreur: ${error.message} | Serveur: ${selectedServerName} | Salon: ${selectedChannelName}`
        );

        elements.sendError.textContent = `‚ùå Erreur lors de l'envoi: ${error.message}`;
        showElement(elements.sendError);

        if (isAdmin || isModo) {
            loadLogs();
        }
    } finally {
        isLoading = false;
        updateSendButton();
    }
}

// Fonctions Firebase
async function saveLog(action, details) {
    try {
        await db.collection('logs').add({
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            userEmail: currentUser.email,
            discordPseudo: userDiscordPseudo,
            action: action,
            details: details,
            createdAt: new Date()
        });
    } catch (error) {
        console.error('Erreur sauvegarde log:', error);
    }
}

async function loadAuthorizedUsers() {
    if (!isAdmin && !isModo) return;

    try {
        const usersSnapshot = await db.collection('authorized_users').orderBy('pseudo').get();
        let usersHtml = '';

        if (usersSnapshot.empty) {
            usersHtml = '<div class="p-5 text-center text-gray-500">Aucun utilisateur autoris√©.</div>';
        } else {
            usersSnapshot.forEach(doc => {
                const userData = doc.data();
                const pseudo = doc.id;
                const addedBy = userData.addedBy || 'Inconnu';
                const addedAt = userData.addedAt ? userData.addedAt.toDate().toLocaleDateString('fr-FR') : 'Date inconnue';

                usersHtml += `
                    <div class="user-item">
                        <div>
                            <div style="font-weight: 500;">${pseudo}</div>
                            <div style="font-size: 0.75rem; color: #6b7280;">
                                Ajout√© par ${addedBy} le ${addedAt}
                            </div>
                        </div>
                        <button class="btn btn-danger" style="padding: 6px 12px; font-size: 0.75rem;" onclick="removeAuthorizedUser('${pseudo}')">
                            üóëÔ∏è Supprimer
                        </button>
                    </div>
                `;
            });
        }

        elements.authorizedUsersList.innerHTML = usersHtml;
    } catch (error) {
        console.error('Erreur chargement utilisateurs autoris√©s:', error);
        elements.authorizedUsersList.innerHTML = '<div class="p-5 text-center text-red-600">Erreur lors du chargement.</div>';
    }
}

async function addAuthorizedUser() {
    const pseudo = elements.newUserPseudo.value.trim();
    if (!pseudo) {
        alert('Veuillez entrer un pseudo Discord');
        return;
    }

    if (!isAdmin && !isModo) {
        alert('Vous n\'avez pas les permissions pour ajouter des utilisateurs');
        return;
    }

    try {
        const doc = await db.collection('authorized_users').doc(pseudo).get();
        if (doc.exists) {
            alert('Ce pseudo Discord est d√©j√† autoris√©');
            return;
        }

        await db.collection('authorized_users').doc(pseudo).set({
            pseudo: pseudo,
            addedBy: userDiscordPseudo,
            addedAt: firebase.firestore.FieldValue.serverTimestamp(),
            addedByEmail: currentUser.email
        });

        await saveLog('Utilisateur autoris√© ajout√©', `Pseudo Discord ajout√©: ${pseudo}`);

        loadAuthorizedUsers();
        elements.newUserPseudo.value = '';
        alert(`‚úÖ Pseudo Discord "${pseudo}" ajout√© avec succ√®s !`);

        if (isAdmin || isModo) {
            loadLogs();
        }
    } catch (error) {
        console.error('Erreur ajout utilisateur:', error);
        alert(`‚ùå Erreur lors de l'ajout: ${error.message}`);
    }
}

async function removeAuthorizedUser(pseudo) {
    if (!isAdmin && !isModo) {
        alert('Vous n\'avez pas les permissions pour supprimer des utilisateurs');
        return;
    }

    if (!confirm(`√ätes-vous s√ªr de vouloir supprimer "${pseudo}" de la liste des utilisateurs autoris√©s ?`)) {
        return;
    }

    try {
        await db.collection('authorized_users').doc(pseudo).delete();

        await saveLog('Utilisateur autoris√© supprim√©', `Pseudo Discord supprim√©: ${pseudo}`);

        loadAuthorizedUsers();
        alert(`‚úÖ Pseudo Discord "${pseudo}" supprim√© avec succ√®s !`);

        if (isAdmin || isModo) {
            loadLogs();
        }
    } catch (error) {
        console.error('Erreur suppression utilisateur:', error);
        alert(`‚ùå Erreur lors de la suppression: ${error.message}`);
    }
}

async function loadLogs() {
    if (!isAdmin && !isModo) return;

    try {
        const logsSnapshot = await db.collection('logs')
            .orderBy('timestamp', 'desc')
            .limit(50)
            .get();

        let logsHtml = '';

        if (logsSnapshot.empty) {
            logsHtml = 'Aucun log disponible.';
        } else {
            logsSnapshot.forEach(doc => {
                const log = doc.data();
                const timestamp = log.timestamp ? log.timestamp.toDate().toLocaleString('fr-FR') : 'Date inconnue';

                logsHtml += `
                    <div class="log-entry">
                        <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">${timestamp}</div>
                        <div style="font-weight: 600; color: #d4af37;">üë§ ${log.discordPseudo} (${log.userEmail})</div>
                        <div style="color: #374151;">üéØ ${log.action}</div>
                        ${log.details ? `<div style="font-size: 0.75rem; color: #6b7280; margin-top: 4px;">${log.details}</div>` : ''}
                    </div>
                `;
            });
        }

        elements.logs.innerHTML = logsHtml;
    } catch (error) {
        console.error('Erreur chargement logs:', error);
        elements.logs.innerHTML = 'Erreur lors du chargement des logs.';
    }
}

// Observer d'authentification
setTimeout(() => {
    if (elements.loadingScreen && !elements.loadingScreen.classList.contains('hidden')) {
        showAuthScreen();
    }
}, 10000);

auth.onAuthStateChanged(async (user) => {
    if (user) {
        currentUser = user;
        const roles = checkUserRole(user.email);
        isAdmin = roles.isAdmin;
        isModo = roles.isModo;

        const savedPseudo = localStorage.getItem('discordPseudo');
        if (savedPseudo) {
            userDiscordPseudo = savedPseudo;
        }
        showMainPanel();
    } else {
        showAuthScreen();
    }
});

// Event listeners
document.querySelectorAll('.auth-tab').forEach(tab => {
    tab.addEventListener('click', (e) => {
        const tabName = e.target.dataset.tab;
        
        document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');

        if (tabName === 'login') {
            showElement(elements.loginForm);
            hideElement(elements.registerForm);
        } else {
            hideElement(elements.loginForm);
            showElement(elements.registerForm);
        }

        clearMessages();
    });
});

if (elements.loginForm) {
    elements.loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const discordPseudo = document.getElementById('loginDiscordPseudo').value;

        clearMessages();
        try {
            const userCredential = await auth.signInWithEmailAndPassword(email, password);
            userDiscordPseudo = discordPseudo;
            localStorage.setItem('discordPseudo', discordPseudo);
        } catch (error) {
            showError(`Erreur de connexion: ${error.message}`);
        }
    });
}

if (elements.logoutBtn) {
    elements.logoutBtn.addEventListener('click', async () => {
        try {
            await auth.signOut();
            localStorage.removeItem('discordPseudo');
            userDiscordPseudo = '';
            currentUser = null;
            isAdmin = false;
            isModo = false;
        } catch (error) {
            console.error('Erreur d√©connexion:', error);
        }
    });
}

// Event listeners du panel
elements.categorySelect.addEventListener('change', (e) => {
    const categoryKey = e.target.value;
    resetSelection();
    
    if (categoryKey === 'jeux') {
        showView('games');
    } else if (categoryKey) {
        selectedCategory = categoryKey;
        showWeekButtons(categoryKey, false);
    }
    updateBadges();
});

elements.gamesView.addEventListener('click', (e) => {
    if (e.target.dataset.game) {
        selectedGame = e.target.dataset.game;
        selectedCategory = '';
        showView('game-detail');
        showWeekButtons(selectedGame, true);
        resetSelection();
        selectedGame = e.target.dataset.game;
        updateBadges();
    }
});

elements.loadServerBtn.addEventListener('click', loadServerChannels);
elements.sendBtn.addEventListener('click', sendToDiscord);
elements.addUserBtn.addEventListener('click', addAuthorizedUser);

elements.newUserPseudo.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        addAuthorizedUser();
    }
});

elements.backBtn.addEventListener('click', () => {
    if (currentView === 'game-detail') {
        showView('games');
        selectedGame = '';
    } else if (currentView === 'games') {
        showView('main');
        elements.categorySelect.value = '';
    }
    resetSelection();
});

// Initialisation
updateBadges();
updateSendButton();

// Rendre les fonctions globales pour les onclick
window.removeAuthorizedUser = removeAuthorizedUser;

console.log('üéâ Initialisation termin√©e');
</script>
